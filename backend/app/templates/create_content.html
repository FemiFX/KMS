{% extends "base.html" %}

{% block title %}Create Content - Knowledge Management System{% endblock %}

{% block content %}
<section class="py-16 bg-ivory-mist dark:bg-heritage-charcoal min-h-screen">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between mb-8">
            <div>
                <p class="text-sm uppercase tracking-wide text-clay-taupe">Creation</p>
                <h1 class="font-display font-bold text-4xl text-heritage-charcoal dark:text-ivory-mist">Create New Content</h1>
                <p class="text-graphite dark:text-warm-sand mt-2">Start a new article, video, or audio entry. No authentication required.</p>
            </div>
            <a href="/contents" class="inline-flex items-center px-4 py-2 rounded-lg bg-warm-sand dark:bg-graphite text-heritage-charcoal dark:text-ivory-mist hover:bg-deep-terracotta hover:text-ivory-mist dark:hover:bg-civic-emerald transition-colors text-sm font-semibold">
                ‚Üê Back to Browse
            </a>
        </div>

        <div id="alert" class="hidden mb-6 p-4 rounded-lg border text-sm"></div>

        <div class="bg-white dark:bg-ink-blue border border-warm-sand dark:border-graphite rounded-2xl shadow-xl p-6 sm:p-8">
            <form id="content-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <label class="block">
                        <span class="text-sm font-medium text-heritage-charcoal dark:text-warm-sand">Content Type</span>
                        <select name="type" class="mt-2 w-full rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3">
                            <option value="article">Article</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                        </select>
                    </label>
                    <label class="block">
                        <span class="text-sm font-medium text-heritage-charcoal dark:text-warm-sand">Visibility</span>
                        <select name="visibility" class="mt-2 w-full rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3">
                            <option value="public">Public</option>
                            <option value="org">Org</option>
                            <option value="private">Private</option>
                        </select>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <label class="block">
                        <span class="text-sm font-medium text-heritage-charcoal dark:text-warm-sand">Primary Language</span>
                        <select name="language" class="mt-2 w-full rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3">
                            {% for code in supported_languages %}
                            <option value="{{ code }}" {% if code == current_language %}selected{% endif %}>{{ code|upper }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="block">
                        <span class="text-sm font-medium text-heritage-charcoal dark:text-warm-sand">Title</span>
                        <input name="title" type="text" class="mt-2 w-full rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3" placeholder="Enter title" required>
                    </label>
                </div>

                <label class="block">
                    <span class="text-sm font-medium text-heritage-charcoal dark:text-warm-sand">Markdown</span>
                    <div id="markdown-editor" data-input-id="markdown-input" class="mt-2 rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal p-3"></div>
                    <!-- Hidden textarea to hold value for form submission -->
                    <textarea id="markdown-input" name="markdown" class="hidden" aria-hidden="true" required></textarea>
                    <noscript>
                        <textarea name="markdown" rows="10" class="mt-2 w-full rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3 font-mono text-sm" placeholder="# Start writing your content with Markdown" required></textarea>
                    </noscript>
                </label>

                <div>
                    <span class="text-sm font-medium text-heritage-charcoal dark:text-warm-sand">Tags</span>
                    <p class="text-xs text-graphite dark:text-warm-sand/70 mt-1">Select existing tags or type new ones separated by commas.</p>
                    <div class="mt-3 flex flex-wrap gap-2" id="existing-tags">
                        {% for tag in tags %}
                        <label class="inline-flex items-center px-3 py-1 rounded-full border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-sm text-heritage-charcoal dark:text-ivory-mist cursor-pointer">
                            <input type="checkbox" value="{{ tag.key }}" class="mr-2">
                            {{ tag.default_label }}
                        </label>
                        {% endfor %}
                    </div>
                    <input id="new-tags" type="text" class="mt-3 w-full rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3 text-sm" placeholder="Add new tags (comma separated)">
                </div>

                <div id="media-fields" class="hidden space-y-4 border-t border-warm-sand dark:border-graphite pt-4">
                    <p class="text-sm font-medium text-heritage-charcoal dark:text-warm-sand">Media Metadata (optional)</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input name="object_key" type="text" placeholder="Object key / URL" class="rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3 text-sm">
                        <input name="mime_type" type="text" placeholder="MIME type (e.g., video/mp4)" class="rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3 text-sm">
                        <input name="duration_seconds" type="number" step="0.1" placeholder="Duration seconds" class="rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3 text-sm">
                        <input name="thumbnail_key" type="text" placeholder="Thumbnail key / URL" class="rounded-lg border border-warm-sand dark:border-graphite bg-ivory-mist dark:bg-heritage-charcoal text-heritage-charcoal dark:text-ivory-mist p-3 text-sm">
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <p class="text-sm text-graphite dark:text-warm-sand/70">UUIDs are generated automatically. Slugs are generated from the title per translation.</p>
                    <button type="submit" class="inline-flex items-center px-6 py-3 rounded-lg bg-deep-terracotta text-ivory-mist hover:bg-civic-emerald transition-colors font-semibold">
                        Create Content
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const form = document.getElementById('content-form');
    const alertBox = document.getElementById('alert');
    const mediaFields = document.getElementById('media-fields');
    const typeSelect = form.querySelector('select[name="type"]');

    const showAlert = (message, isError = false) => {
        alertBox.textContent = message;
        alertBox.classList.remove('hidden');
        alertBox.classList.toggle('bg-red-100', isError);
        alertBox.classList.toggle('border-red-300', isError);
        alertBox.classList.toggle('text-red-800', isError);
        alertBox.classList.toggle('bg-green-100', !isError);
        alertBox.classList.toggle('border-green-300', !isError);
        alertBox.classList.toggle('text-green-800', !isError);
    };

    typeSelect.addEventListener('change', () => {
        mediaFields.classList.toggle('hidden', typeSelect.value === 'article');
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const type = formData.get('type');

        const checkedTags = Array.from(document.querySelectorAll('#existing-tags input[type="checkbox"]:checked')).map(cb => cb.value);
        const newTagsRaw = (document.getElementById('new-tags').value || '').split(',').map(t => t.trim()).filter(Boolean);
        const tags = [...checkedTags, ...newTagsRaw];

        const payload = {
            type,
            visibility: formData.get('visibility') || 'public',
            translations: [{
                language: formData.get('language') || 'en',
                title: formData.get('title'),
                markdown: formData.get('markdown') || '',
                is_primary: true
            }],
            tags
        };

        if (type !== 'article') {
            payload.media = {
                object_key: formData.get('object_key') || null,
                mime_type: formData.get('mime_type') || null,
                duration_seconds: formData.get('duration_seconds') || null,
                thumbnail_key: formData.get('thumbnail_key') || null,
                original_language: formData.get('language') || 'en'
            };
        }

        try {
            const res = await fetch('/api/contents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.error || 'Failed to create content');
            }

            showAlert('Content created! Redirecting...', false);
            if (data.id) {
                setTimeout(() => {
                    window.location.href = `/contents/${data.id}?lang=${payload.translations[0].language}`;
                }, 800);
            }
        } catch (err) {
            showAlert(err.message || 'Error creating content', true);
        }
    });
</script>
<script type="module" src="{{ url_for('static', filename='dist/main.js') }}"></script>
{% endblock %}
