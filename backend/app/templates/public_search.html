{% extends "base.html" %}

{% block title %}Suche: {{ query }} - UN-Dekade{% endblock %}

{% block content %}
<!-- Search Header -->
<div class="bg-gradient-to-br from-charcoal via-inkblue to-emerald-900 text-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 font-heading">Suchergebnisse</h1>

        <!-- Search Box -->
        <form action="{{ url_for('public.search_page') }}" method="GET" class="max-w-3xl">
            <input type="hidden" name="lang" value="{{ current_language or 'de' }}">
            <div class="flex items-center bg-white rounded-full shadow-xl overflow-hidden mb-4">
                <div class="pl-6 text-taupe">
                    <i class="fas fa-magnifying-glass text-lg"></i>
                </div>
                <input
                    type="text"
                    name="q"
                    value="{{ query }}"
                    placeholder="Suchen..."
                    class="flex-1 px-4 py-3 text-charcoal placeholder-taupe focus:outline-none bg-transparent"
                    autofocus
                >
                <button
                    type="submit"
                    class="px-6 py-3 bg-heritage hover:bg-heritage-600 transition-colors text-charcoal font-semibold"
                >
                    Suchen
                </button>
            </div>

            <!-- Tag Filter -->
            <div class="relative">
                <div class="flex flex-wrap gap-2 items-center bg-white/90 dark:bg-graphite-800/90 rounded-lg p-3 shadow-lg">
                    <label class="text-sm font-medium text-charcoal dark:text-ivory">Tags:</label>
                    <div id="selected-tags-container" class="flex flex-wrap gap-2 flex-1"></div>
                    <input
                        type="text"
                        id="tag-search-input"
                        placeholder="Tag hinzufügen..."
                        class="px-3 py-1 text-sm text-charcoal dark:text-ivory bg-white dark:bg-graphite-700 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-heritage"
                        autocomplete="off"
                    >
                </div>
                <!-- Tag suggestions dropdown -->
                <div id="tag-search-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-graphite-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                </div>
            </div>
        </form>
    </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {% if query %}
        <!-- Results Summary -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-charcoal dark:text-ivory mb-2">
                {% if total > 0 %}
                    {{ total }} Ergebnis{% if total != 1 %}se{% endif %} für "{{ query }}"
                {% else %}
                    Keine Ergebnisse für "{{ query }}"
                {% endif %}
            </h2>
        </div>

        {% if category_counts and (category_counts.article > 0 or category_counts.video > 0 or category_counts.audio > 0 or category_counts.publication > 0) %}
        <!-- Category Breakdown -->
        <div class="mb-8 bg-sand-50 dark:bg-charcoal-900 rounded-xl p-6">
            <h3 class="text-lg font-semibold text-charcoal dark:text-ivory mb-4">Ergebnisse nach Kategorie</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="?q={{ query }}&type=article&lang={{ current_language }}"
                   class="category-count-card {% if content_type == 'article' %}active{% endif %}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-3xl font-bold text-emerald dark:text-heritage">{{ category_counts.article or 0 }}</div>
                            <div class="text-sm text-taupe dark:text-sand-300 mt-1">Artikel</div>
                        </div>
                        <i class="fas fa-file-lines text-2xl text-emerald/30 dark:text-heritage/30"></i>
                    </div>
                </a>

                <a href="?q={{ query }}&type=video&lang={{ current_language }}"
                   class="category-count-card {% if content_type == 'video' %}active{% endif %}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-3xl font-bold text-terracotta dark:text-heritage">{{ category_counts.video or 0 }}</div>
                            <div class="text-sm text-taupe dark:text-sand-300 mt-1">Videos</div>
                        </div>
                        <i class="fas fa-video text-2xl text-terracotta/30 dark:text-heritage/30"></i>
                    </div>
                </a>

                <a href="?q={{ query }}&type=audio&lang={{ current_language }}"
                   class="category-count-card {% if content_type == 'audio' %}active{% endif %}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-3xl font-bold text-heritage dark:text-heritage">{{ category_counts.audio or 0 }}</div>
                            <div class="text-sm text-taupe dark:text-sand-300 mt-1">Audio</div>
                        </div>
                        <i class="fas fa-microphone text-2xl text-heritage/30"></i>
                    </div>
                </a>

                <a href="?q={{ query }}&type=publication&lang={{ current_language }}"
                   class="category-count-card {% if content_type == 'publication' %}active{% endif %}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-3xl font-bold text-inkblue dark:text-heritage">{{ category_counts.publication or 0 }}</div>
                            <div class="text-sm text-taupe dark:text-sand-300 mt-1">Publikationen</div>
                        </div>
                        <i class="fas fa-book text-2xl text-inkblue/30 dark:text-heritage/30"></i>
                    </div>
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Top Results -->
        {% if results and results|length > 0 %}
        <div class="mb-8">
            <h3 class="text-xl font-bold text-charcoal dark:text-ivory mb-4">
                {% if content_type %}
                    {{ content_type|capitalize }}-Ergebnisse
                {% else %}
                    Top-Ergebnisse
                {% endif %}
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for result in results %}
                <a href="{{ url_for('public.' + result.type + '_detail', content_id=result.id, lang=current_language) }}" class="content-card group">
                    <div class="content-card-image bg-gradient-to-br {{ result.gradient }} relative overflow-hidden">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-black/30 transition-colors"></div>
                        <div class="absolute top-4 left-4">
                            <span class="content-badge content-badge-{{ result.type }}">
                                <i class="fas {{ result.icon }} mr-2"></i>{{ result.type_label }}
                            </span>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent">
                            <h3 class="text-white text-lg font-bold mb-1 line-clamp-2">{{ result.title }}</h3>
                        </div>
                    </div>
                    <div class="p-5">
                        <p class="text-sm text-taupe dark:text-sand-300 mb-3 line-clamp-3">{{ result.excerpt }}</p>
                        <div class="flex items-center justify-between text-xs text-taupe dark:text-sand-400">
                            <span>{{ result.created_at }}</span>
                            {% if result.tags and result.tags|length > 0 %}
                            <div class="flex gap-1">
                                {% for tag in result.tags[:2] %}
                                <span class="tag">{{ tag }}</span>
                                {% endfor %}
                                {% if result.tags|length > 2 %}
                                <span class="tag">+{{ result.tags|length - 2 }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if total > per_page %}
            <div class="flex items-center justify-center space-x-4 mt-8">
                {% if page > 1 %}
                <a href="?q={{ query }}&type={{ content_type }}&lang={{ current_language }}&page={{ page - 1 }}"
                   class="px-6 py-2 bg-white dark:bg-graphite-800 border border-sand-300 dark:border-graphite-600 rounded-lg hover:bg-sand-50 dark:hover:bg-graphite-700 transition-colors text-charcoal dark:text-ivory font-medium">
                    <i class="fas fa-chevron-left mr-2"></i>Zurück
                </a>
                {% endif %}

                <span class="px-4 py-2 text-taupe dark:text-sand-300">
                    Seite {{ page }} von {{ (total + per_page - 1) // per_page }}
                </span>

                {% if page * per_page < total %}
                <a href="?q={{ query }}&type={{ content_type }}&lang={{ current_language }}&page={{ page + 1 }}"
                   class="px-6 py-2 bg-white dark:bg-graphite-800 border border-sand-300 dark:border-graphite-600 rounded-lg hover:bg-sand-50 dark:hover:bg-graphite-700 transition-colors text-charcoal dark:text-ivory font-medium">
                    Weiter<i class="fas fa-chevron-right ml-2"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- No Results -->
        <div class="text-center py-16">
            <div class="w-20 h-20 bg-sand-200 dark:bg-graphite-700 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-search text-taupe dark:text-sand-400 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-charcoal dark:text-ivory mb-2">Keine Ergebnisse gefunden</h3>
            <p class="text-taupe dark:text-sand-300 mb-6">
                Versuchen Sie es mit anderen Suchbegriffen oder stöbern Sie in unseren Kategorien.
            </p>
            <a href="{{ url_for('public.index', lang=current_language) }}" class="btn-primary inline-block">
                <i class="fas fa-home mr-2"></i>Zur Startseite
            </a>
        </div>
        {% endif %}
    {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="w-20 h-20 bg-sand-200 dark:bg-graphite-700 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-magnifying-glass text-taupe dark:text-sand-400 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-charcoal dark:text-ivory mb-2">Geben Sie einen Suchbegriff ein</h3>
            <p class="text-taupe dark:text-sand-300">
                Durchsuchen Sie unsere umfassende Sammlung von Artikeln, Videos, Audio und Publikationen.
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.category-count-card {
    display: block;
    padding: 1.5rem;
    background: white;
    border-radius: 0.75rem;
    border: 2px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
}

html.dark .category-count-card {
    background: #3B3A38;
}

.category-count-card:hover {
    border-color: #2F6E47;
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

html.dark .category-count-card:hover {
    border-color: #D8A843;
}

.category-count-card.active {
    border-color: #2F6E47;
    background: rgba(47, 110, 71, 0.05);
}

html.dark .category-count-card.active {
    border-color: #D8A843;
    background: rgba(216, 168, 67, 0.1);
}

.content-card {
    display: block;
    background: white;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    transition: all 0.3s;
}

html.dark .content-card {
    background: #3B3A38;
}

.content-card:hover {
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    transform: translateY(-4px);
}

.content-card-image {
    width: 100%;
    height: 200px;
    position: relative;
}

.content-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: capitalize;
}

.content-badge-article {
    background: rgba(47, 110, 71, 0.9);
    color: white;
}

.content-badge-video {
    background: rgba(167, 78, 57, 0.9);
    color: white;
}

.content-badge-audio {
    background: rgba(216, 168, 67, 0.9);
    color: #1F1E1D;
}

.content-badge-publication {
    background: rgba(36, 60, 90, 0.9);
    color: white;
}

.tag {
    padding: 0.25rem 0.5rem;
    background: rgba(233, 220, 196, 0.2);
    border-radius: 0.375rem;
    font-weight: 500;
}

html.dark .tag {
    background: rgba(129, 117, 103, 0.3);
}

.from-emerald {
    background: linear-gradient(135deg, #2F6E47, #478f67);
}

.from-terracotta {
    background: linear-gradient(135deg, #A74E39, #d26449);
}

.from-heritage {
    background: linear-gradient(135deg, #D8A843, #e4bc5a);
}

.from-inkblue {
    background: linear-gradient(135deg, #243C5A, #4c7392);
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const tagInput = document.getElementById('tag-search-input');
    const tagSuggestions = document.getElementById('tag-search-suggestions');
    const selectedTagsContainer = document.getElementById('selected-tags-container');
    const form = tagInput.closest('form');

    let selectedTags = [];
    let debounceTimer;

    // Search tags with debounce
    async function searchTags(query) {
        if (!query) {
            tagSuggestions.classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(`/api/tags?search=${encodeURIComponent(query)}`);
            const data = await response.json();
            const tags = data.tags || [];

            if (tags.length === 0) {
                tagSuggestions.classList.add('hidden');
                return;
            }

            // Filter out already selected tags
            const availableTags = tags.filter(tag =>
                !selectedTags.some(selected => selected.key === tag.key)
            );

            if (availableTags.length === 0) {
                tagSuggestions.classList.add('hidden');
                return;
            }

            displayTagSuggestions(availableTags);
        } catch (error) {
            console.error('Failed to search tags:', error);
        }
    }

    function displayTagSuggestions(tags) {
        tagSuggestions.innerHTML = '';

        tags.forEach(tag => {
            const div = document.createElement('div');
            div.className = 'px-4 py-2 hover:bg-gray-100 dark:hover:bg-graphite-700 cursor-pointer flex items-center justify-between';
            div.innerHTML = `
                <span class="text-sm text-charcoal dark:text-ivory">${tag.label || tag.default_label}</span>
                ${tag.color ? `<span class="w-3 h-3 rounded-full ml-2" style="background-color: ${tag.color}"></span>` : ''}
            `;
            div.addEventListener('click', () => {
                addTag({
                    key: tag.key,
                    label: tag.label || tag.default_label,
                    color: tag.color
                });
                tagInput.value = '';
                tagSuggestions.classList.add('hidden');
            });
            tagSuggestions.appendChild(div);
        });

        tagSuggestions.classList.remove('hidden');
    }

    // Tag input event listeners
    tagInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        const query = e.target.value.trim();

        if (query.length >= 1) {
            debounceTimer = setTimeout(() => searchTags(query), 300);
        } else {
            tagSuggestions.classList.add('hidden');
        }
    });

    tagInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            tagSuggestions.classList.add('hidden');
        }
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!tagInput.contains(e.target) && !tagSuggestions.contains(e.target)) {
            tagSuggestions.classList.add('hidden');
        }
    });

    function addTag(tag) {
        if (selectedTags.some(t => t.key === tag.key)) {
            return;
        }

        selectedTags.push(tag);
        renderSelectedTags();
        form.submit(); // Auto-submit when tag is added
    }

    function removeTag(tagKey) {
        selectedTags = selectedTags.filter(t => t.key !== tagKey);
        renderSelectedTags();
        form.submit(); // Auto-submit when tag is removed
    }

    function renderSelectedTags() {
        selectedTagsContainer.innerHTML = '';

        selectedTags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-heritage/20 dark:bg-heritage/30 text-charcoal dark:text-ivory';
            tagElement.innerHTML = `
                ${tag.label}
                <button type="button" class="ml-2 hover:opacity-70 transition-opacity" onclick="removeTag('${tag.key}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            // Add hidden input for form submission
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'tags';
            hiddenInput.value = tag.key;
            tagElement.appendChild(hiddenInput);

            selectedTagsContainer.appendChild(tagElement);
        });
    }

    // Make removeTag available globally
    window.removeTag = removeTag;

    // Initialize with URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const tagParams = urlParams.getAll('tags');
    if (tagParams.length > 0) {
        // Load tag details from API
        tagParams.forEach(async (tagKey) => {
            try {
                const response = await fetch(`/api/tags?search=${encodeURIComponent(tagKey)}`);
                const data = await response.json();
                const tag = data.tags?.find(t => t.key === tagKey);
                if (tag) {
                    selectedTags.push({
                        key: tag.key,
                        label: tag.label || tag.default_label,
                        color: tag.color
                    });
                    renderSelectedTags();
                }
            } catch (error) {
                console.error('Failed to load tag:', error);
            }
        });
    }
});
</script>
{% endblock %}
