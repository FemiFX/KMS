{# Document list with inline preview + modal viewer for images/PDFs/DOCX #}
<div class="bg-white dark:bg-indigo-800 rounded-xl shadow-md p-6">
  <h3 class="text-lg font-heading font-bold text-gray-900 dark:text-ivory mb-4">{{ title or 'Dokumente' }}</h3>
  {% if documents %}
    <ul class="space-y-4">
      {% for doc in documents %}
        {% set ext = doc.original_filename.split('.')[-1]|lower %}
        {% set inline_url = url_for(download_endpoint, document_id=doc.id, inline=1) %}
        <li class="border border-indigo-100 dark:border-indigo-700 rounded-lg p-4">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="min-w-0">
              <p class="doc-filename text-sm font-semibold text-gray-900 dark:text-ivory" title="{{ doc.original_filename }}">{{ doc.original_filename }}</p>
              <p class="text-xs text-gray-700 dark:text-ivory/70">{{ doc.document_type.value.replace('_',' ').title() }} • {{ doc.file_size_mb }} MB</p>
              {% set scan_state = doc.scan_status.value if doc.scan_status else 'pending' %}
              {% if scan_state == 'clean' %}
                <span class="inline-flex items-center px-2 py-0.5 mt-1 text-[11px] font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100">Scan: Clean</span>
              {% elif scan_state == 'infected' %}
                <span class="inline-flex items-center px-2 py-0.5 mt-1 text-[11px] font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100">Scan: Infected</span>
              {% elif scan_state == 'failed' %}
                <span class="inline-flex items-center px-2 py-0.5 mt-1 text-[11px] font-semibold rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-100">Scan: Fehlgeschlagen</span>
              {% else %}
                <span class="inline-flex items-center px-2 py-0.5 mt-1 text-[11px] font-semibold rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-100">Scan: Ausstehend</span>
              {% endif %}
            </div>
            <div class="flex items-center flex-wrap gap-2">
              {% if scan_state == 'clean' %}
                <a href="{{ url_for(download_endpoint, document_id=doc.id) }}" class="px-3 py-1 text-xs bg-indigo-100 text-gray-800 dark:bg-indigo-700 dark:text-ivory rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-600">Download</a>
                <button type="button" class="px-3 py-1 text-xs bg-gray-100 dark:bg-indigo-600 text-gray-800 dark:text-ivory rounded-lg hover:bg-gray-200 dark:hover:bg-indigo-500 doc-preview-link" data-src="{{ inline_url }}" data-type="{{ ext }}">
                  Anzeigen
                </button>
              {% else %}
                <span class="px-3 py-1 text-xs bg-gray-100 text-gray-500 dark:bg-indigo-900 dark:text-indigo-200 rounded-lg">Download nach Scan</span>
              {% endif %}
            </div>
          </div>
          {% if ext in ['png', 'jpg', 'jpeg', 'webp'] %}
            <div class="mt-3">
              <img src="{{ inline_url }}" alt="Dokument Vorschau" class="rounded-lg border border-indigo-100 dark:border-indigo-700 max-h-56 object-contain hover:shadow-lg transition-transform hover:scale-[1.02]">
            </div>
          {% elif ext == 'pdf' %}
            <div class="mt-3">
              <object data="{{ inline_url }}" type="application/pdf" class="w-full h-96 rounded-lg border border-indigo-100 dark:border-indigo-700">
                <a href="{{ url_for(download_endpoint, document_id=doc.id) }}" class="text-coral-500">PDF anzeigen</a>
              </object>
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-sm text-gray-600 dark:text-ivory/70">Keine Dokumente hochgeladen.</p>
  {% endif %}
</div>

<style>
  .doc-filename {
    max-width: 18rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
  }
  .doc-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 50;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .doc-modal-backdrop.show { display: flex; }
  .doc-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    color: #111827;
    background: #f8fafc;
    border-radius: 9999px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    cursor: pointer;
    border: 1px solid rgba(17,24,39,0.15);
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }
  .doc-modal-body {
    position: relative;
    width: 95vw;
    height: 95vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .doc-modal-content {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    border: none;
    background: transparent;
    object-fit: contain;
    margin: 0;
    display: block;
  }
</style>

<!-- Optional: Mammoth.js for DOCX support -->
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

<script>
  (function() {
    const modal = document.createElement('div');
    modal.id = 'docModal';
    modal.className = 'doc-modal-backdrop';
    modal.innerHTML = `
      <div class="doc-modal-body">
        <button id="docModalClose" class="doc-modal-close" aria-label="Schließen">&times;</button>
        <div id="docModalBody" class="w-full h-full flex items-center justify-center">
          <p class="text-sm text-gray-100">Laden…</p>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    async function openModal(src, type) {
      const body = document.getElementById('docModalBody');
      body.innerHTML = '<p class="text-sm text-gray-100">Laden…</p>';

      const isImage = ['png','jpg','jpeg','webp','gif'].includes(type);
      const isPdf = type === 'pdf';
      const isDocx = ['docx', 'doc'].includes(type);

      if (isImage) {
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Dokument';
        img.className = 'doc-modal-content';
        img.style.objectFit = 'contain';
        body.innerHTML = '';
        body.appendChild(img);
      } else if (isPdf) {
        const obj = document.createElement('object');
        obj.data = src;
        obj.type = 'application/pdf';
        obj.className = 'doc-modal-content';
        body.innerHTML = '';
        body.appendChild(obj);
      } else if (isDocx && typeof mammoth !== 'undefined') {
        try {
          const response = await fetch(src);
          const arrayBuffer = await response.arrayBuffer();
          const result = await mammoth.convertToHtml({arrayBuffer});
          const container = document.createElement('div');
          container.className = 'doc-modal-content overflow-auto p-8 bg-white dark:bg-gray-800 rounded-lg';
          container.style.maxWidth = '800px';
          container.style.height = '100%';
          container.innerHTML = result.value;

          const style = document.createElement('style');
          style.textContent = `
            #docModalBody .doc-modal-content { font-family: 'Inter', system-ui, -apple-system, sans-serif; line-height: 1.6; color: #1f2937; }
            .dark #docModalBody .doc-modal-content { color: #f9fafb; }
            #docModalBody .doc-modal-content p { margin-bottom: 1em; }
            #docModalBody .doc-modal-content h1, #docModalBody .doc-modal-content h2, #docModalBody .doc-modal-content h3 { font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; }
            #docModalBody .doc-modal-content ul, #docModalBody .doc-modal-content ol { margin-left: 1.5em; margin-bottom: 1em; }
            #docModalBody .doc-modal-content table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
            #docModalBody .doc-modal-content td, #docModalBody .doc-modal-content th { border: 1px solid #d1d5db; padding: 0.5em; }
            .dark #docModalBody .doc-modal-content td, .dark #docModalBody .doc-modal-content th { border-color: #4b5563; }
          `;
          document.head.appendChild(style);
          body.innerHTML = '';
          body.appendChild(container);
          if (result.messages.length > 0) console.log('DOCX conversion messages:', result.messages);
        } catch (error) {
          console.error('Error rendering DOCX:', error);
          body.innerHTML = `
            <div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg">
              <p class="text-red-600 dark:text-red-400 mb-4">Fehler beim Laden des Dokuments</p>
              <a href="${src.replace('inline=1', '')}" download class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                Stattdessen herunterladen
              </a>
            </div>
          `;
        }
      } else {
        const iframe = document.createElement('iframe');
        iframe.src = src;
        iframe.className = 'doc-modal-content';
        body.innerHTML = '';
        body.appendChild(iframe);
      }
      modal.classList.add('show');
    }

    document.querySelectorAll('.doc-preview-link').forEach(btn => {
      btn.addEventListener('click', () => {
        const src = btn.getAttribute('data-src');
        const type = btn.getAttribute('data-type');
        openModal(src, type);
      });
    });

    document.getElementById('docModalClose').addEventListener('click', () => modal.classList.remove('show'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
  })();
</script>
